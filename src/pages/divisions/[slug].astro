---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import HeroSection from '../../components/HeroSection.astro';

export async function getStaticPaths() {
  const divisions = await getCollection('divisions');
  return divisions.map((division) => ({
    params: { slug: division.data.slug ?? division.id.replace(/\.md$/, '') },
    props: { division }
  }));
}

const { division } = Astro.props;
const divisionSlug = division.data.slug ?? division.id.replace(/\.md$/, '');
const projects = await getCollection('projects', ({ data }) => data.division === divisionSlug);
---

<BaseLayout title={`Techmach | ${division.data.title}`} description={division.data.summary}>
  <HeroSection image={division.data.heroImage} title={division.data.title} text={division.data.summary} />

  <section class="mx-auto max-w-7xl px-6 py-16">
    <h2 class="mb-6 text-2xl font-semibold">Services</h2>
    <ul class="grid gap-4 md:grid-cols-2">
      {division.data.services.map((service) => (
        <li class="rounded border border-slate-200 p-4 text-slate-700">â€¢ {service}</li>
      ))}
    </ul>
  </section>

  <section class="mx-auto max-w-7xl px-6 pb-16">
    <h2 class="mb-6 text-2xl font-semibold">Gallery</h2>
    <div class="grid gap-4 md:grid-cols-3">
      {division.data.gallery.map((image, index) => (
        <a href={image} target="_blank" class="block overflow-hidden rounded border border-slate-200">
          <img src={image} alt={`${division.data.title} image ${index + 1}`} class="h-52 w-full object-cover" loading="lazy" />
        </a>
      ))}
    </div>
  </section>

  {projects.length > 0 && (
    <section class="bg-slate-100 py-16">
      <div class="mx-auto max-w-7xl px-6">
        <h2 class="mb-6 text-2xl font-semibold">Related Projects</h2>
        <div class="grid gap-4 md:grid-cols-3">
          {projects.map((project) => (
            <a href={`/projects/${project.data.slug ?? project.id.replace(/\.md$/, '')}/`} class="rounded bg-white p-5 shadow-sm">
              <h3 class="font-semibold">{project.data.title}</h3>
              <p class="text-sm text-slate-600">{project.data.location}</p>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}
</BaseLayout>
